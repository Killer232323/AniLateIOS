window.Yummyanime = window.Yummyanime || {};

(async function(namespace) {
    const fetchJson = async (url) => {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        return response.json();
    };

    const getThumbnailUrl = (animePoster) => {
        const baseImageUrl = "https://img.yani.tv";
        return animePoster.fullsize.startsWith('//')
            ? `https:${animePoster.fullsize}`
            : animePoster.fullsize.startsWith('/')
                ? `${baseImageUrl}${animePoster.fullsize}`
                : animePoster.fullsize;
    };

    const dubName = (str) => str.replace(`Озвучка `, ``);

    const status = (int) => {
        return int === 0 ? 3 : int === 1 ? 2 : int === 2 ? 1 : 0;
    };

    const fetchFromUrl = async (url) => {
        try {
            const data = await fetchJson(url);
            return JSON.stringify(data.response.map(anime => ({
                url: anime.anime_url,
                title: anime.title,
                views: anime.views,
                thumbnail_url: getThumbnailUrl(anime.poster),
                status: status(anime.status)
            })), null, 2);
        } catch (error) {
            return `Ошибка: ${error.message}`;
        }
    };

    const fetchFromDetails = async (id = 10907) => {
        try {
            const data = await fetchJson(`https://api.yani.tv/anime/${id}`);
            const responce = data.response;
            return JSON.stringify({
                url: responce.anime_url,
                title: responce.title,
                views: responce.views,
                description: responce.description,
                thumbnail_url: getThumbnailUrl(responce.poster),
                status: status(responce.status)
            }, null, 2);
        } catch (error) {
            return `Ошибка: ${error.message}`;
        }
    };

    const fetchVideo = async (id) => {
        try {
            const { response: { anime_id } } = await fetchJson(`https://api.yani.tv/anime/${id}`);
            const data = await fetchJson(`https://api.yani.tv/anime/${anime_id}/videos`);
            const result = await Promise.all(data.response.map(async (video) => ({
                dubbingName: dubName(video.data.dubbing),
                playerName: video.data.player,
                videoId: `${video.video_id}`,
                videoUrl: video.iframe_url,
                videoNumber: parseInt(video.number, 10),
                videoName: null,
                dateUpload: video.date,
                isFrame: false,
            })));

            return JSON.stringify(result, null, 2);
        } catch (error) {
            return `Ошибка: ${error.message}`;
        }
    };

    namespace.FetchPopular = async (offset = 0) => {
        const url = `https://api.yani.tv/anime?sort=rating&offset=${offset * 30}&limit=30`;
        return fetchFromUrl(url);
    };

    namespace.FetchLatestUpdates = async (offset = 0) => {
        const url = `https://api.yani.tv/anime?offset=${offset * 30}&limit=30`;
        return fetchFromUrl(url);
    };

    namespace.FetchVideos = (id = "alya-inogda-koketnichaet-so-mnoy-po-russki") => fetchVideo(id);
    namespace.FetchDetails = (id = 10907) => fetchFromDetails(id);
})(window.Yummyanime);