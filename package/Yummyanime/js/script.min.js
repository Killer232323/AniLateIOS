const fetchFromUrl = async (url) => {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        const data = await response.json();
        // Получаем список данных аниме
        const animeData = data.response.map(anime => ({
            id: anime.anime_id,
            title: anime.title,
            views: anime.views,
            cover: `https:${anime.poster.fullsize}`,
        }));
        // Преобразуем данные в JSON-строку
        return JSON.stringify(animeData);
    } catch (error) {
        return `Ошибка: ${error.message}`;
    }
}


const fetchVideo = async (url) => {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const data = await response.json();
        const result = [];

        data.response.forEach(video => {
            const { dubbing: dubbingName, player: playerName } = video.data;
            let dubbing = result.find(d => d.name === dubbingName) || { id: video.video_id, 
                                                                        name: dubbingName.replace( /Озвучка /i, ""),
                                                                        players: [] };

            if (!result.includes(dubbing)) result.push(dubbing);
            let player = dubbing.players.find(p => p.name === playerName) || { name: playerName, videos: [] };

            if (!dubbing.players.includes(player)) dubbing.players.push(player);
             player.videos.push({
                id: video.video_id,
                url: video.iframe_url,
                position: parseInt(video.number, 10)
            });
        });

        return JSON.stringify(result, null, 2);
    } catch (error) {
        return `Ошибка: ${error.message}`;
    }
};

window.Yummyanime1fetchPopular = async (offset = 0) => {
    try {
        const url = `https://api.yani.tv/anime?sort=rating&offset=${offset * 30}&limit=30`;
        const data = await fetchFromUrl(url);
        console.log(data)
        return data;
    } catch (error) {
        console.error(error)
        return error;
    }
}

window.Yummyanime1fetchLatestUpdates = async (offset = 0) => {
    try {
        const url = `https://api.yani.tv/anime?offset=${offset * 30}&limit=30`;
        const data = await fetchFromUrl(url);
        console.log(data)
        return data;
    } catch (error) {
        console.error(error)
        return error;
    }
}

window.Yummyanime1fetchVideos = (id = 10907) => fetchVideo(`https://api.yani.tv/anime/${id}/videos`);
