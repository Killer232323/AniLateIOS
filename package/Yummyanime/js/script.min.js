const fetchFromUrl = async (url) => {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        const data = await response.json();
        // Получаем список данных аниме
        const animeData = data.response.map(anime => ({
            url: anime.anime_url,
            title: anime.title,
            views: anime.views,
            thumbnail_url: getThumbnailUrl(anime.poster),
            status: status(anime.status)
        }));
        // Преобразуем данные в JSON-строку
        return JSON.stringify(animeData);
    } catch (error) {
        return `Ошибка: ${error.message}`;
    }
}

const fetchFromDetails = async (id = 10907) => {
    try {
        const response = await fetch(`https://api.yani.tv/anime/${id}`);
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        const data = await response.json();
        const responce = data.response;
        // Преобразуем данные в объект
        const animeData = {
            //   ["response"]: {
            url: responce.anime_url,
            title: responce.title,
            views: responce.views,
            descr: responce.description,
            thumbnail_url: getThumbnailUrl(responce.poster),
            status: status(responce.status)
            //  }
        };
        // Преобразуем данные в JSON-строку
        return JSON.stringify(animeData);
    } catch (error) {
        return `Ошибка: ${error.message}`;
    }
}

const fetchVideo = async (id) => {
    try {
        const _idAnime = await fetch(`https://api.yani.tv/anime/${id}`);
        if (!_idAnime.ok) throw new Error(`HTTP error ${_idAnime.status}`);

        const { response: { anime_id } } = await _idAnime.json();
        const response = await fetch(`https://api.yani.tv/anime/${anime_id}/videos`);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const data = await response.json();
        const result = [];

        await Promise.all(data.response.map(async (video) => {
            const {dubbing: dubbingName, player: playerName} = video.data;

            result.push({
                dubbingName: dubName(dubbingName),
                playerName: playerName,

                videoId: `${video.video_id}`,
                videoUrl: video.iframe_url,
                videoPosition: parseInt(video.number, 10),
                videoName: null,
                dateUpload: video.date,
                isFrame: false,
            });
        }));

        return JSON.stringify(result, null, 2);
    } catch (error) {
        return `Ошибка: ${error.message}`;
    }
};
function getThumbnailUrl(animePoster) {
    const baseImageUrl = "https://img.yani.tv"; // Замените на ваш базовый URL

    // Проверяем, является ли полный адрес относительным
    return animePoster.fullsize.startsWith('//')
        ? `https:${animePoster.fullsize}`
        : animePoster.fullsize.startsWith('/')
            ? `${baseImageUrl}${animePoster.fullsize}`
            : animePoster.fullsize;
}
const dubName = str => str.replace(`Озвучка `, ``);
const status = (int) => {
    switch (int) {
        case 0: return 3
        case 1: return 2
        case 2: return 1
        default: return 0
    }
}

window.Yummyanime1fetchPopular = async (offset = 0) => {
    try {
        const url = `https://api.yani.tv/anime?sort=rating&offset=${offset * 30}&limit=30`;
        const data = await fetchFromUrl(url);
        console.log(data)
        return data;
    } catch (error) {
        console.error(error)
        return error;
    }
}

window.Yummyanime1fetchLatestUpdates = async (offset = 0) => {
    try {
        const url = `https://api.yani.tv/anime?offset=${offset * 30}&limit=30`;
        const data = await fetchFromUrl(url);
        console.log(data)
        return data;
    } catch (error) {
        console.error(error)
        return error;
    }
}

window.Yummyanime1fetchVideos = (id = "alya-inogda-koketnichaet-so-mnoy-po-russki") => fetchVideo(id);
window.Yummyanime1fetchDetails = (id = 10907) => fetchFromDetails(id);
