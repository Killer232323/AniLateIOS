window.Anixtar = window.Anixtar || {};


/*
* age_rating: 5->18+ 4->13+ 3->13+ 2->6+ 1->0+
* type: 1->TV 2->Movie 3->OVA 4->Dorama(not used) 6->Special
*
*/
(async function(namespace) {

    const errorOptions = [
        { code: 1, message: 'Заблокировано' },
        { code: 2, message: 'Список пуст' },
    ];


    const fetchJson = async (url) => {
        const response = await fetch(url, {
            headers: {
                'api-version': 'v2',
            },
        });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        return response.json();
    };

    const fetchVideo = async (id) => {
        try {
            const data = await fetchJson(`https://api-s2.anixart.tv/episode/${id}`);
            const result = [];

            if(data.code === 1) await Promise.reject(new Error(`Заблокировано`));
            if (!data.types || data.types.length === 0) {
               await Promise.reject(new Error(`No video` ));
            }

            const dubbingPromises = data.types.map(async (dubbing) => {
                const players = await fetchJson(`https://api-s2.anixart.tv/episode/${id}/${dubbing.id}`);
                const playerPromises = players.sources.map(async (player) => {
                    const video = await fetchJson(`https://api-s2.anixart.tv/episode/${id}/${dubbing.id}/${player.id}`);
                    const videoItems = video.episodes.map(videoItem => ({
                        dubbingName: dubbing.name,
                        playerName: player.name,
                        videoId: genVideoId(id,dubbing.id,player.id,videoItem["@id"]),
                        videoUrl: videoItem.url,
                        videoNumber: videoItem.position,
                        videoName: videoItem.name,
                        dateUpload: videoItem.addedDate,
                        isFrame: videoItem.iframe,
                    }));
                    result.push(...videoItems);
                });
                return Promise.all(playerPromises);
            });
            await Promise.all(dubbingPromises);

            return JSON.stringify(result, null, 2);
        } catch (error) {
            throw error;
        }
    };

    const fetchFromUrl = async (url, is_json = true) => {
        try {
            const data = await fetchJson(url);
            const result = data.content.map(anime => ({
                url: anime.id,
                title: anime.title_ru,
                views: anime.views,
                thumbnail_url: anime.image,
                status: anime.status?.id ? status(anime.status.id) : 0
            }));
            return is_json ? JSON.stringify(result, null, 2) : result;
        } catch (error) {
            throw `Ошибка: ${error}`;
        }
    };

    const fetchFromDetails = async (id = 10907) => {
        try {

            const data = await fetchJson(`https://api.anixart.tv/release/${id}`);
            const response = data.release;

            const related_data = await fetchFromUrl(`https://api.anixart.tv/related/${response.related.id}/0`, false);
            const viewingOrder = Array.isArray(related_data) ? related_data : null;

            const rating = parseFloat((response.grade).toFixed(2)) * 2;

            return JSON.stringify({
                url: response.id,
                title: response.title_ru,
                title_original: response.title_original,
                description: response.description,
                year: response.year,
                episode_total_count: response.episodes_total,
                episode_duration: response.duration,
                rating: rating !== 0 ? `${rating}` : null,
                type: type(response.category.id),
                age_rating: age_rating(response.age_rating),
                thumbnail_url: response.image,
                status: status(response.status.id),
                viewing_order: viewingOrder
            }, null, 2);
        } catch (error) {
            throw `Ошибка: ${error}`;
        }
    };

    const genVideoId = (releaseId, sourceId,playerId, vidId) => {
        return `${releaseId}${sourceId}${playerId}${vidId}`;
    };

    const status = (int) => {
        return int === 1 ? 3 : int === 2 ? 2 : int === 3 ? 1 : 0;
    };

    const age_rating = (int) => {
        return int === 1 ? 1 : int === 2 ? 2 : int === 3 ? 3 : int === 4 ? 3 : int === 5 ? 5 : 0;
    };
    const type = (int) => {
        return int === 1 ? 1 : int === 2 ? 4 : int === 3 ? 2 : int === 6 ? 5 : 0;
    };

    namespace.FetchVideos = (id = 20075) => fetchVideo(id);
    namespace.FetchDetails = (id = 19348) => fetchFromDetails(id);

    namespace.FetchPopular = async (offset = 0) => {
        const url = `https://api.anixart.tv/filter/${offset}?token=&studio=&category=&status=&year=&episodes=&sort=1&country=&season=&duration=&extended_mode=true`;
        return fetchFromUrl(url);
    };

    namespace.FetchLatestUpdates = async (offset = 0) => {
        const url = `https://api.anixart.tv/filter/${offset}?token=&studio=&category=&status=&year=&episodes=&sort=&country=&season=&duration=&extended_mode=true`;
        return fetchFromUrl(url);
    };
})(window.Anixtar);